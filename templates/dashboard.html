{% extends "base.html" %}
{% block content %}
<h1>Dashboard</h1>
<h2>Welcome, {{ user.full_name }}</h2>
{% if user.role == 'coordinator' %}
  <a href="{{ url_for('logged_in_users') }}" class="btn btn-info">View Logged-in Users</a>
{% endif %}
<form method="post">
  {% if user.role == 'coordinator' %}
    <div class="mb-3">
      <input type="checkbox" name="subcommittee" id="subcommittee" {% if user.role == 'subcommittee' %}checked{% endif %}>
      <label for="subcommittee">Sub-committee Access</label>
    </div>
  {% endif %}
  <h3>Event Options</h3>
  <table class="table">
    <thead>
      <tr>
        <th>Name</th>
        <th>Price (R)</th>
        <th>Select</th>
      </tr>
    </thead>
    <tbody>
      {% for option in options %}
        <tr>
          <td>{{ option.name }}</td>
          <td>R{{ option.price | round(2) }}</td>
          <td>
            <input type="checkbox" name="option" value="{{ option.id }}" {% if option in user_options %}checked disabled{% endif %}>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
  <h3>Activities</h3>
  <table class="table">
    <thead>
      <tr>
        <th>Date and Time</th>
        <th>Name</th>
        <th>Location</th>
        <th>Price (R)</th>
        <th>Slots Available</th>
        <th>Select</th>
      </tr>
    </thead>
    <tbody>
      {% for activity in activities %}
        {% set disabled = activity in user_activities or (activity.slots > 0 and activity.user_activities | length >= activity.slots) %}
        {% for slot in activity.timeslots.split(';') %}
          {% set start, end = slot.split(',') %}
          {% set start_dt = start | as_datetime %}
          {% set end_dt = end | as_datetime %}
          <tr {% if disabled or activity in user_activities %}class="text-muted"{% endif %}>
            <td>{{ start_dt.strftime('%A %H:%M') }} - {{ end_dt.strftime('%H:%M') }}</td>
            <td>{{ activity.name }}</td>
            <td>{{ activity.location }}</td>
            <td>R{{ activity.price | round(2) }}</td>
            <td>{{ activity.slots - (activity.user_activities | length) if activity.slots > 0 else 'Unlimited' }}</td>
            <td>
              <input type="checkbox" name="activity" value="{{ activity.id }}" {% if activity in user_activities %}checked disabled{% endif %} {% if disabled %}disabled{% endif %}>
            </td>
          </tr>
        {% endfor %}
      {% endfor %}
    </tbody>
  </table>
  <h3>Payment Upload</h3>
  <div class="mb-3">
    <input type="file" name="payment_file" class="form-control" accept=".png,.jpg,.jpeg,.pdf">
  </div>
  <button type="submit" class="btn btn-primary">Save Changes</button>
</form>
<h3>Your Selections</h3>
<p>Total Cost: R{{ ((user.event_options | sum(attribute='price')) + (user.user_activities | map(attribute='activity.price') | sum)) | round(2) }}</p>
<h4>Options</h4>
<ul>
  {% for option in user_options %}
    <li>{{ option.name }} - R{{ option.price | round(2) }}</li>
  {% endfor %}
</ul>
<h4>Activities</h4>
<ul>
  {% for ua in user_activities %}
    {% for slot in ua.activity.timeslots.split(';') %}
      {% set start, end = slot.split(',') %}
      {% set start_dt = start | as_datetime %}
      {% set end_dt = end | as_datetime %}
      <li>{{ start_dt.strftime('%A %H:%M') }} - {{ end_dt.strftime('%H:%M') }}: {{ ua.activity.name }} ({{ ua.activity.location }}) - R{{ ua.activity.price | round(2) }}</li>
    {% endfor %}
  {% endfor %}
</ul>
<h4>Payments</h4>
<ul>
  {% for payment in payments %}
    <li>{{ payment.filename }} (Uploaded: {{ payment.upload_date }})</li>
  {% endfor %}
</ul>
<a href="{{ url_for('logout') }}" class="btn btn-secondary">Logout</a>
{% if user.role in ['subcommittee', 'coordinator'] %}
  <a href="{{ url_for('admin_activities') }}" class="btn btn-primary">Manage Activities</a>
  <a href="{{ url_for('admin_options') }}" class="btn btn-primary">Manage Options</a>
  <a href="{{ url_for('report_master') }}" class="btn btn-primary">Master Report</a>
  <a href="{{ url_for('report_summary') }}" class="btn btn-primary">Summary Report</a>
  <a href="{{ url_for('activity_report') }}" class="btn btn-primary">Activity Report</a>
{% endif %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const checkboxes = document.querySelectorAll('input[name="activity"]');
  checkboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      const selectedActivities = Array.from(document.querySelectorAll('input[name="activity"]:checked')).map(cb => cb.value);
      checkboxes.forEach(cb => {
        const activityId = cb.value;
        const row = cb.closest('tr');
        const timeslots = row.cells[0].textContent.split(' - ');
        const start = new Date(timeslots[0].replace(/(\w+) (\d+:\d+)/, '2026-10-$2'));
        const end = new Date(timeslots[1].replace(/(\w+) (\d+:\d+)/, '2026-10-$2'));
        const location = row.cells[2].textContent;
        let conflict = false;
        selectedActivities.forEach(selectedId => {
          if (selectedId !== activityId) {
            const selectedRow = document.querySelector(`input[value="${selectedId}"]`).closest('tr');
            const selectedTimeslots = selectedRow.cells[0].textContent.split(' - ');
            const selectedStart = new Date(selectedTimeslots[0].replace(/(\w+) (\d+:\d+)/, '2026-10-$2'));
            const selectedEnd = new Date(selectedTimeslots[1].replace(/(\w+) (\d+:\d+)/, '2026-10-$2'));
            const selectedLocation = selectedRow.cells[2].textContent;
            if ((start < selectedEnd && end > selectedStart) && location !== selectedLocation) {
              conflict = true;
            }
          }
        });
        if (conflict) {
          row.classList.add('text-muted');
          cb.disabled = true;
        } else {
          row.classList.remove('text-muted');
          cb.disabled = false;
        }
      });
    });
  });
});
</script>
{% for message in get_flashed_messages() %}
  <div class="alert alert-info">{{ message }}</div>
{% endfor %}
{% endblock %}