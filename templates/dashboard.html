{% extends "base.html" %}
{% block content %}
<h1>Dashboard <span class="float-end">
  <form method="post" action="{{ url_for('toggle_subcommittee') }}" class="form-check form-switch">
    <input class="form-check-input" type="checkbox" name="subcommittee" id="subcommitteeToggle" {% if user.role == 'subcommittee' %}checked{% endif %}>
    <label class="form-check-label" for="subcommitteeToggle">Sub-committee Mode (Testing)</label>
  </form>
</span></h1>
<p>Welcome, {{ user.full_name }} (Membership: {{ user.membership_number }})</p>
<h2>Selected Options</h2>
<ul>
  {% for option in options %}
    <li>{{ option.name }} (R{{ option.price }}) - {{ option.status | capitalize }}</li>
  {% endfor %}
</ul>
<h2>Activities</h2>
<div id="activities">
  {% for activity in activities %}
    <div class="form-check" id="act-{{ activity.id }}">
      {% if activity.slots > 0 and get_attendees_count(activity.id) >= activity.slots %}
        <label>
          {{ activity.name }} ({{ activity.location }}, R{{ activity.price }}) 
          <br>
          {% for slot in activity.timeslots.split(';') %}
            {% set start, end = slot.split(',') %}
            {% set start_dt = start | as_datetime %}
            {% set end_dt = end | as_datetime %}
            {{ start_dt.strftime('%A %H:%M to ') }}{{ end_dt.strftime('%H:%M') }}<br>
          {% endfor %}
          - Fully Booked
        </label>
      {% else %}
        <input type="checkbox" class="form-check-input activity-toggle" data-id="{{ activity.id }}" {% if activity.id in selected %}checked{% endif %}>
        <label>
          {{ activity.name }} ({{ activity.location }}, R{{ activity.price }}) 
          <br>
          {% for slot in activity.timeslots.split(';') %}
            {% set start, end = slot.split(',') %}
            {% set start_dt = start | as_datetime %}
            {% set end_dt = end | as_datetime %}
            {{ start_dt.strftime('%A %H:%M to ') }}{{ end_dt.strftime('%H:%M') }}<br>
          {% endfor %}
        </label>
      {% endif %}
    </div>
  {% endfor %}
</div>
<h3>Total Cost: R<span id="total">0</span></h3>
<h2>Upload Payment Confirmation</h2>
<form method="post" action="{{ url_for('upload_payment') }}" enctype="multipart/form-data">
  <div class="mb-3">
    <label>Amount (R)</label>
    <input type="number" name="amount" step="0.01" class="form-control" required>
  </div>
  <div class="mb-3">
    <label>File</label>
    <input type="file" name="file" required>
  </div>
  <button type="submit" class="btn btn-primary">Upload</button>
</form>
{% if user.payments %}
  <h3>Payments</h3>
  <ul>
    {% for payment in user.payments %}
      <li>R{{ payment.amount | float | format('%.2f') }} ({{ payment.created_at.strftime('%Y-%m-%d %H:%M') }}) - {{ payment.file }}</li>
    {% endfor %}
  </ul>
{% endif %}
<a href="{{ url_for('change_password') }}" class="btn btn-info">Change Password</a>
{% if user.role in ['subcommittee', 'coordinator'] %}
  <a href="{{ url_for('admin_activities') }}" class="btn btn-info">Edit Activities</a>
  <a href="{{ url_for('admin_options') }}" class="btn btn-info">Edit Options</a>
  <a href="{{ url_for('report_master') }}" class="btn btn-info">Master Report</a>
  <a href="{{ url_for('report_summary') }}" class="btn btn-info">Registration Summary</a>
  <a href="{{ url_for('activity_report') }}" class="btn btn-info">Activity Report</a>
{% endif %}
{% if user.role == 'coordinator' %}
  <a href="{{ url_for('admin_users') }}" class="btn btn-info">Manage Users</a>
{% endif %}
<a href="{{ url_for('logout') }}" class="btn btn-danger">Logout</a>

<script>
$(document).ready(function() {
  const activities = {{ activities | tojson | safe }};
  console.log('Activities loaded:', activities);

  function parseTimeslots(ts) {
    if (!ts || typeof ts !== 'string') {
      console.error('Invalid or empty timeslots:', ts);
      return [];
    }
    try {
      return ts.split(';').map(slot => {
        if (!slot.includes(',')) {
          console.error('Invalid slot format:', slot);
          return null;
        }
        const [start, end] = slot.split(',');
        const startDate = new Date(start.trim());
        const endDate = new Date(end.trim());
        if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
          console.error('Invalid date in slot:', slot);
          return null;
        }
        return { start: startDate, end: endDate };
      }).filter(slot => slot !== null);
    } catch (e) {
      console.error('Error parsing timeslots:', ts, e);
      return [];
    }
  }

  activities.forEach(act => {
    act.parsedTimeslots = parseTimeslots(act.timeslots);
    console.log('Parsed timeslots for', act.name, ':', act.parsedTimeslots);
  });

  function hasOverlap(ts1, ts2) {
    const overlap = ts1.start < ts2.end && ts2.start < ts1.end;
    console.log('Checking overlap:', ts1.start, ts2.end, ts2.start, ts1.end, 'Result:', overlap);
    return overlap;
  }

  function isConflict(selectedActs, candidate) {
    console.log('Checking conflicts for', candidate.name, 'with selected:', selectedActs.map(a => a.name));
    for (let sel of selectedActs) {
      if (sel.id === candidate.id) continue;
      for (let tsSel of sel.parsedTimeslots) {
        for (let tsCand of candidate.parsedTimeslots) {
          if (hasOverlap(tsSel, tsCand)) {
            console.log('Overlap detected:', sel.name, 'vs', candidate.name);
            return true;
          }
          if (sel.location !== candidate.location && 
              tsCand.start > tsSel.end && 
              tsCand.start < new Date(tsSel.end.getTime() + 60*60*1000)) {
            console.log('Location-time conflict:', sel.name, 'vs', candidate.name);
            return true;
          }
        }
      }
    }
    return false;
  }

  function updateGreyed() {
    const selected = [];
    $('.activity-toggle:checked').each(function() {
      const id = parseInt($(this).data('id'));
      const activity = activities.find(a => a.id === id);
      if (activity) {
        selected.push(activity);
      } else {
        console.error('Activity not found for ID:', id);
      }
    });
    console.log('Selected activities:', selected.map(a => a.name));
    activities.forEach(act => {
      const elem = $('#act-' + act.id);
      const isConflicting = isConflict(selected, act);
      console.log('Activity', act.name, 'is conflicting:', isConflicting);
      if (isConflicting) {
        elem.addClass('text-muted');
        elem.find('input').prop('disabled', true).prop('checked', false);
      } else {
        elem.removeClass('text-muted');
        elem.find('input').prop('disabled', false);
      }
    });
    let total = 0;
    selected.forEach(act => total += parseFloat(act.price));
    $('#total').text(total.toFixed(2));
    console.log('Updated total:', total);
  }

  $('.activity-toggle').change(function() {
    const id = parseInt($(this).data('id'));
    console.log('Checkbox changed for ID:', id);
    $.ajax({
      url: '/select_activity/' + id,
      type: 'POST',
      success: function(response) {
        console.log('Select activity response:', response);
        updateGreyed();
      },
      error: function(jqXHR, textStatus, errorThrown) {
        console.error('Select activity failed:', textStatus, errorThrown);
        alert('Failed to update activity selection. Please try again.');
      }
    });
  });

  updateGreyed();
});
</script>
{% endblock %}